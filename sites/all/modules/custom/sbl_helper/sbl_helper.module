<?php

function filter_single_games_player($row) {
  $player = arg(1);
  $season = arg(2);

  if(($row->field_mt_player_1_1 == $player || $row->field_mt_player_2_1 == $player) && $row->field_tm_saison_1 == $season) {
    return FALSE;
  } else {
    return TRUE;
  }
}

/*
 * Load scripts and the matching jquery versions on certain pages
 */

function sbl_helper_init() {


  $module_path = drupal_get_path('module', 'sbl_helper');

// load the slick script and jquery 1.11 on the front page

// load the diplayed path. This is necessary for paths that are just aliases
// It also works for system paths and thus is more reliable than arg(x)
  $path = drupal_get_path_alias($_GET['q']);
  $path_array = explode('/', $path);

  if (drupal_is_front_page()) {
    drupal_add_js(libraries_get_path('jquery-1.11') . '/jquery-1.11.1.min.js');
    drupal_add_css(libraries_get_path('slick') . '/slick/slick.css');
    drupal_add_js(libraries_get_path('slick') . '/slick/slick.min.js');
    drupal_add_js('var jq111 = jQuery; jQuery.noConflict(true);',
      array('type' => 'inline', 'scope' => 'header'));
    drupal_add_js($module_path . '/js/sbl_slick_slider.js');
  }
}

/**
 * implements hook_views_pre_render()
 * Change the titles of some views programmatically
 * based on arguments
 */
function sbl_helper_views_pre_render(&$view) {
  // Set the title for the "Aktuelle Tabelle" depending on the season tid
  // from the URL
  if ($view->name == 'teams_leaderbord' && $view->current_display == 'page') {
    $tid = arg(1);
    $term = taxonomy_term_load($tid);
    $view->build_info['title'] = 'Aktuelle Tabelle ' . $term->name;
  }
}

/**
 * Custom Funktion, um die Ergebnisse pro Spieltag auszugeben
 *
 */
function print_results_matchday(){

$season = '';
$matchday = '';
$match_node = '';

// Print the results for a matchday
// We get the season and the matchday from the URL
$season = arg(1);
$matchday = arg(2);

// Now get all Team Match nodes for that specific Match Day
$matches_match_day = new EntityFieldQuery();

$matches_match_day->entityCondition('entity_type', 'node')
  ->entityCondition('bundle', 'team_match')
  ->fieldCondition('field_tm_saison', 'tid', $season)
  ->fieldCondition('field_tm_spieltag_1', 'value', $matchday)
  // Bypass node access
  ->addTag('DANGEROUS_ACCESS_CHECK_OPT_OUT');

$matches_match_day_result = $matches_match_day->execute();
if(isset($matches_match_day_result['node'])) {
  $matches = array_keys($matches_match_day_result['node']);
  foreach($matches as $match_node) {
    // print an instance of the view "Ergebnisse" for each of the team_match nodes
    print views_embed_view('match_results', 'block', $season, $matchday, $match_node);
  }
}
$season_title_raw = taxonomy_term_load($season);
$season_title = $season_title_raw->name;

// Set the title to show the season and Spieltag
drupal_set_title('Ergebnisse ' . $matchday . '. Spieltag ' . $season_title);
}

function check_current_season_matchday($row) {
  // Get the current season and the current matchday as
  // set in the sbl settings module
  $current_season = get_current_season();
  $current_matchday = get_current_matchday();
  // Show only the elements that have the season and matchday as set in SBL settings
  if($current_season == $row->field_tm_saison && $current_matchday == $row->field_tm_spieltag_1) {
    return FALSE;
  } else {
    return TRUE;
  }
}
function check_current_season_date_matchday($row) {
  // Get the current season and the Date for the matchday as
  // set in SBL Settings
  $current_season = get_current_season();
  $date_matchday = get_date_matchday();
  $date_row = $row->field_datum;
  $date_row_object = new DateTime($date_row);
  $date_row_formatted = date_format($date_row_object, 'Y-m-d');
//  dpm($date_matchday);
//  dpm($date_row_formatted);

  // Show only the elements that have the season and date as set in SBL settings
  if($current_season == $row->field_tm_saison && $date_matchday == $date_row_formatted) {
    return FALSE;
  } else {
    return TRUE;
  }
}

function statistics_check_type_of_page() {
  // Find out on which page of our statistics area we are.
  // There are some panels pages
  $page_type = '';
  if (panels_get_current_page_display()) {
    $page_type = 'panel_';
    switch(arg(0)) {
      case 'verein':
        $page_type .= 'verein';
        break;
      case 'spieler':
        $page_type .= 'spieler';
        break;
      case 'ergebnisse':
        $page_type .= 'ergebnisse';
        break;
    }
  }
  // and some views
  $views_page = views_get_page_view(); // Does this need a check in order not to throw an error?
  if (is_object($views_page)) {
    $page_type = 'view_' . $views_page->name;
  }
  // return as a variable where we are.
  return $page_type;
}

function statistics_create_navigation() {
  // Create a navigation block to get to the statistics area we want

  // Set default values for season and matchday
  $season = get_current_season();
  $matchday = get_current_matchday();

  // Get the season from the url arguments
  switch(statistics_check_type_of_page()) {
    case 'panel_verein':
    case 'panel_spieler':
      $season = arg(2);
      break;
    case 'panel_ergebnisse':
      $season = arg(1);
      break;
    case 'panel_ergebnisse':
    case 'view_spielplan':
    case 'view_teams_leaderboard':
      $season = arg(1);
      break;
  }

  // Set the necessary variables for our theme_list() function
  $title = 'Tabellen';
  $type = 'ul';
  $attributes = array('class' => array('tabelle', 'spielplan', 'ergebnisse'));
  $list_items = array();
  $list_items[] = l('Tabelle', 'tabelle/' . $season);
  $list_items[] = l('Spielplan', 'spielplan/' . $season);
  $list_items[] = l('Ergebnisse', 'ergebnisse/' . $season . '/' . $matchday);

  // Create an unordered List with the navigation items
  $output = theme_item_list(array('items' => $list_items, 'title' => $title, 'type' => $type, 'attributes' => $attributes));


  return $output;
}
